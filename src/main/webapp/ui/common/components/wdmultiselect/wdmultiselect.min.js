/*multiselect 1.0*/
(function($) {
	$.fn.multiselect = function(objs) {
		this[0].parentElement.style.position = "relative";
		var defaults = {
			sPopupwidth: 310

		}

		var objs = $.extend(defaults, objs);
		this.each(function() {
			var thisSelect = $(this);
			var thisId = thisSelect.attr("name");
			var html = "<div class='multiselect-box' id='box-" + thisId + "'><input type='text' id='" + thisId + "' name='" + thisId + "' style='display:none'/><input type='text' id='xs-" + thisId + "'></input><input type='button'class='multiselect-xz' ></input></div>";

			var mtitle = "<div class='sPopupTitle'><a href='javascript:void(0);' class='multi-btn-qd' id='multi-qd-"+thisId+"'>确定</a><a href='javascript:void(0);' class='multi-btn-qk' id='multi-qk-"+thisId+"'>清空</a><a href='javascript:void(0);' class='multi-btn-qx'>取消</a></div>"
				//var items = 
			var _len = thisSelect[0].length;
			var mOutItem = "";
			var mbody = "<div class='sPopupBlock' id='mbody-" + thisId + "'></div>"
			$("body").append("<div class='sPopupDiv' style='width:" + objs.sPopupwidth + "px;' id='sPopup-" + thisId + "'></div>");

			$("#sPopup-" + thisId).append(mtitle);
			$("#sPopup-" + thisId).append(mbody);
			$("#mbody-" + thisId).append("<div class='seledbuttonSel' id='seled" + thisId + "'></div>");
			$("#mbody-" + thisId).append("<div class='pItemB' id='itemb-" + thisId + "'></div>")
			var mval = "";
			var mtxt = "";
			for (var i = 0; i < _len; i++) {
				var length = thisSelect[0][i].innerHTML.length;
				var wid = 100;
				if (length > 6 && length <= 12) {
					wid = 200;
				} else if (length > 12) {
					wid = objs.sPopupwidth;
				}
				if ($(thisSelect[0][i]).attr("selected") == "selected") {
					mOutItem += "<span class='mOutItem' style='width:" + wid + "px;'><label class='noselItem' for='" + thisId + "-" + thisSelect[0][i].value + "'><input checked='true' name='n" + thisId + "' type='checkbox' id='" + thisId + "-" + thisSelect[0][i].value + "' iname='" + thisSelect[0][i].innerHTML + "' val='" + thisSelect[0][i].value + "' />" + thisSelect[0][i].innerHTML + "</label></span>"
					$("#seled" + thisId).append("<span class='multiSelectItem' id='multiSel" + thisSelect[0][i].id + "' iname='" + thisSelect[0][i].innerHTML + "' val='" + thisSelect[0][i].value + "'>" + thisSelect[0][i].innerHTML + "<a href='javascript:void(0);' class='seledClose'></a></span>");
					if (mval == "") {
						mval = thisSelect[0][i].value;
						mtxt = thisSelect[0][i].innerHTML
					} else {
						mval += "," + thisSelect[0][i].value;
						mtxt += " + " + thisSelect[0][i].innerHTML;
					}
				} else {
					mOutItem += "<span class='mOutItem' style='width:" + wid + "px;'><label class='noselItem' for='" + thisId + "-" + thisSelect[0][i].value + "'><input name='n" + thisId + "' type='checkbox' id='" + thisId + "-" + thisSelect[0][i].value + "' iname='" + thisSelect[0][i].innerHTML + "' val='" + thisSelect[0][i].value + "' />" + thisSelect[0][i].innerHTML + "</label></span>"
				}

			}
			$("#itemb-" + thisId).append(mOutItem);
			thisSelect.parent().html(html);
			$("#" + thisId).val(mval);
			$("#xs-" + thisId).val(mtxt);
			$("#xs-" + thisId).attr("title", mtxt);
			$(".multi-btn-qx").click(function() {
				$("#sPopup-" + thisId).css({
					"top": "-100px",
					"left": "-100px",
					"visibility": "hidden"
				})
				$(".divMask").remove();
			})
			$("#multi-qk-"+thisId).click(function() {
				$("#seled" + thisId).html("");
				$("input[name='n" + thisId + "']").attr("checked", false)
			})
			$("#multi-qd-"+thisId).click(function() {

				var val = "";
				var tex = "";
				$("#seled" + thisId + " span").each(function(i) {
					if (i == 0) {
						val = $(this).attr("val");
						tex = $(this).attr("iname");
					} else {
						val += "," + $(this).attr("val");
						tex += " + " + $(this).attr("iname");
					}
				})
				$("#" + thisId).val(val);
				$("#xs-" + thisId).val(tex);
				$("#xs-" + thisId).attr("title", tex);
				$("#sPopup-" + thisId).css({
					"top": "-100px",
					"left": "-100px",
					"visibility": "hidden"
				})
				$(".divMask").remove();
			})
			$("#box-" + thisId).click(function() {
				var sel = $("#" + thisId).val();
				if (sel.indexOf(",") != -1) {
					$("input[name='n" + thisId + "']").removeAttr("checked");
					var selected = sel.split(",");
					$("#seled" + thisId).html("");
					for (var i = 0; i < selected.length; i++) {
						$("#" + thisId + "-" + selected[i])[0].checked = true;
						var obj = $("#" + thisId + "-" + selected[i]);
						$("#seled" + thisId).append("<span class='multiSelectItem' id='multiSel" + obj.attr("id") + "' iname='" + obj.attr("iname") + "' val='" + obj.attr("val") + "'>" + obj.attr("iname") + "<a href='javascript:void(0);' class='seledClose'></a></span>");
					}

				} else if (sel != "") {
					$("input[name='n" + thisId + "']").removeAttr("checked");
					$("#seled" + thisId).html("");
					$("#" + thisId + "-" + sel)[0].checked = true;
					var obj = $("#" + thisId + "-" + sel);
					$("#seled" + thisId).append("<span class='multiSelectItem' id='multiSel" + obj.attr("id") + "' iname='" + obj.attr("iname") + "' val='" + obj.attr("val") + "'>" + obj.attr("iname") + "<a href='javascript:void(0);' class='seledClose'></a></span>");

				}else{
					$("input[name='n" + thisId + "']").removeAttr("checked");
					$("#seled" + thisId).html("");
				}
				$(".seledClose").click(function() {
					var id = $(this).parent().attr("id");
					id = id.substr(8, id.length);
					$("#" + id).removeAttr("checked");
					$(this).parent().remove();
				})
				$("body").append("<div class='divMask'></div>")
				var pos = $("#box-" + thisId).position();
				/*判断是否是iframe 修改qiujie 2015-8-6*/
				if (frameElement) {
					var _top = parseInt($("#xs-" + thisId).offset().top);
					var _hei = parseInt($("#mbody-" + thisId).height()) + _top;
					var whei = $(window).height();
					//var _thei = parseInt($("#xs-"+thisId).height())+5;
					if (_hei > whei) {
						$("#sPopup-" + thisId).css({
							"top": pos.top - parseInt($("#mbody-" + thisId).height()) - 5 + "px",
							"left": pos.left - 5 + "px",
							"visibility": "visible"
						})
					}

				} else {
					$("#sPopup-" + thisId).css({
						"top": pos.top + 30 + "px",
						"left": pos.left + "px",
						"visibility": "visible"
					})
				}
			})
			var xzsel = "";
			$("input[name='n" + thisId + "']").click(function() {
				var nId = $(this).attr("id");
				if ($(this).is(':checked')) {
					$("#seled" + thisId).append("<span class='multiSelectItem' id='multiSel" + nId + "' iname='" + $(this).attr("iname") + "' val='" + $(this).attr("val") + "'>" + $(this).attr("iname") + "<a href='javascript:void(0);' class='seledClose'></a></span>")
					$(".seledClose").click(function() {
						var id = $(this).parent().attr("id");
						id = id.substr(8, id.length);
						$("#" + id).attr("checked", false);
						$(this).parent().remove();
					})
				} else {
					$("#multiSel" + $(this).attr("id")).remove();
				}

			})

		});

	};
})(jQuery);